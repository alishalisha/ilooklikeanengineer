MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var t=document.createElement("canvas"),e=MEME.$("#meme-canvas");t&&t.getContext?(e.html(t),this.canvas=t,this.setDownload(),this.render()):e.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var t=document.createElement("a");"undefined"==typeof t.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function t(t){var e=o.background.height,a=o.background.width;if(e&&a){var i=e*h.imageScale,n=a*h.imageScale,d=h.backgroundPosition.x||h.width/2,l=h.backgroundPosition.y||h.height/2;t.drawImage(o.background,0,0,a,e,d-n/2,l-i/2,n,i)}}function e(t){x=95,y=h.height/2;var e="because I am one.";t.textAlign="left",t.font='14px"Source Sans Pro"',t.fillText(e,x,y)}function a(t){var e=Math.round(.75*h.width),a=l,i=l;t.font=h.fontSize+"pt "+h.fontFamily,t.fillStyle=h.fontColor,t.textBaseline="top","left"==h.textAlign?(t.textAlign="left",a=20,i=h.height/2-50,e=h.width-h.width/3):"right"==h.textAlign?(t.textAlign="right",a=h.width-l):t.textAlign="left";for(var n=h.headlineText.split(" "),o="",d=0;d<n.length;d++){var r=o+n[d]+" ",s=t.measureText(r),c=s.width;c>e&&d>0?(t.fillText(o,a,i),o=n[d]+" ",i+=Math.round(1.5*h.fontSize)):o=r}t.fillText(o,a,i),t.shadowColor="transparent"}function i(t){t.fillStyle="#FF775B",t.fillRect(0,0,300,h.height)}function n(t){var e,a,i,n;if(a=n=o.watermark.height,e=i=o.watermark.width,a&&e){var d=h.width*h.watermarkMaxWidthRatio;e>d&&(n=a*(d/e),i=d),t.globalAlpha=h.watermarkAlpha,t.drawImage(o.watermark,0,0,e,a,h.width-l-i,h.height-l-n,i,n),t.globalAlpha=1}}if(this.canvas){var o=this.model,h=this.model.toJSON(),d=this.canvas.getContext("2d"),l=Math.round(h.width*h.paddingRatio);this.canvas.width=h.width,this.canvas.height=h.height,d.clearRect(0,0,h.width,h.height),t(d),i(d),a(d),e(d),n(d);var r=this.canvas.toDataURL();this.$("#meme-download").attr({href:r,download:(h.downloadName||"share")+".png"}),this.canvas.style.cursor=this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(t){function e(t){t.preventDefault(),a.set("backgroundPosition",{x:Math.max(i.width-n,Math.min(d.x-(h.x-t.clientX),n)),y:Math.max(i.height-o,Math.min(d.y-(h.y-t.clientY),o))})}if(t.preventDefault(),this.model.hasBackground()){var a=this.model,i=a.toJSON(),n=a.background.width*i.imageScale/2,o=a.background.height*i.imageScale/2,h={x:t.clientX,y:t.clientY},d=i.backgroundPosition;d.x=d.x||i.width/2,d.y=d.y||i.height/2;var l=MEME.$(document).on("mousemove.drag",e).on("mouseup.drag",function(t){l.off("mouseup.drag mousemove.drag"),e(t)})}}});